<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ğŸ“± WhatsApp Auto Reminder</h1>
        <p class="subtitle">
          Automatic reminders for Fridays & Indonesian Holidays
        </p>
      </header>

      <% if (message) { %>
      <div class="alert alert-success">âœ… <%= message %></div>
      <% } %> <% if (error) { %>
      <div class="alert alert-error">âŒ <%= error %></div>
      <% } %>

      <main>
        <section class="form-section">
          <h2>ğŸ“ Create Auto Reminder</h2>
          <p class="form-description">
            Set up automatic reminders - no date selection needed! System will
            automatically send messages on Fridays and before national holidays.
          </p>

          <form action="/reminder" method="POST" class="reminder-form">
            <div class="form-group">
              <label for="message">Message</label>
              <textarea
                id="message"
                name="message"
                rows="4"
                placeholder="Enter your reminder message...&#10;Example: Jangan lupa selesaikan tugas sebelum weekend! ğŸ‰"
                required
              ></textarea>
            </div>

            <div class="form-group">
              <label for="trigger_time">â° Trigger Time (WIB)</label>
              <input
                type="time"
                id="trigger_time"
                name="trigger_time"
                value="08:00"
                required
              />
              <small
                >Time when reminder will be sent (24-hour format, Jakarta
                timezone)</small
              >
            </div>

            <div class="form-group">
              <label for="group_id">ğŸ‘¥ WhatsApp Group ID</label>
              <input
                type="text"
                id="group_id"
                name="group_id"
                placeholder="e.g., 1203630xxxxxxxx@g.us"
                required
              />
              <small>Format: numbers followed by @g.us</small>
            </div>

            <div class="form-group checkbox-group">
              <label class="section-label">ğŸ”” Reminder Types</label>

              <label class="checkbox-label">
                <input
                  type="checkbox"
                  name="friday_enabled"
                  value="true"
                  checked
                />
                <span class="checkmark"></span>
                <span class="checkbox-text">
                  <strong>ğŸ“… Friday Reminder</strong>
                  <small>Send every Friday at the specified time</small>
                </span>
              </label>

              <label class="checkbox-label">
                <input
                  type="checkbox"
                  name="holiday_enabled"
                  value="true"
                  checked
                />
                <span class="checkmark"></span>
                <span class="checkbox-text">
                  <strong>ğŸŒ Holiday Reminder</strong>
                  <small>Send 1 day before Indonesian national holidays</small>
                </span>
              </label>
            </div>

            <button type="submit" class="btn-submit">
              ğŸš€ Create Auto Reminder
            </button>
          </form>
        </section>

        <% if (upcomingHolidays && upcomingHolidays.length > 0) { %>
        <section class="holidays-section">
          <h2>ğŸŒ Upcoming Indonesian Holidays</h2>
          <div class="holidays-list">
            <% upcomingHolidays.forEach(function(holiday) { %>
            <div class="holiday-item">
              <span class="holiday-date"><%= holiday.date %></span>
              <span class="holiday-name"><%= holiday.localName %></span>
            </div>
            <% }); %>
          </div>
        </section>
        <% } %>

        <section class="reminders-section">
          <h2>ğŸ“‹ Configured Auto Reminders</h2>
          <% if (reminders && reminders.length > 0) { %>
          <div class="reminders-list">
            <% reminders.forEach(function(reminder) { %>
            <div
              class="reminder-card type-<%= reminder.type %> <%= reminder.enabled ? 'enabled' : 'disabled' %>"
            >
              <div class="reminder-header">
                <span class="reminder-id"><%= reminder.id %></span>
                <div class="reminder-badges">
                  <span class="reminder-type <%= reminder.type %>">
                    <% if (reminder.type === 'friday_auto') { %> ğŸ“… Friday <% }
                    else if (reminder.type === 'holiday_auto') { %> ğŸŒ Holiday
                    <% } %>
                  </span>
                  <span
                    class="reminder-status <%= reminder.enabled ? 'active' : 'inactive' %>"
                  >
                    <%= reminder.enabled ? 'âœ… Active' : 'â¸ï¸ Paused' %>
                  </span>
                </div>
              </div>
              <div class="reminder-body">
                <p class="reminder-message"><%= reminder.message %></p>
                <div class="reminder-details">
                  <span>â° <%= reminder.trigger_time %> WIB</span>
                  <span>ğŸ‘¥ <%= reminder.group_id %></span>
                  <% if (reminder.last_sent) { %>
                  <span>ğŸ“¤ Last sent: <%= reminder.last_sent %></span>
                  <% } %>
                </div>
              </div>
              <div class="reminder-actions">
                <button
                  class="btn-toggle <%= reminder.enabled ? 'btn-pause' : 'btn-enable' %>"
                  onclick="toggleReminder('<%= reminder.id %>', <%= reminder.enabled ? 'false' : 'true' %>)"
                >
                  <%= reminder.enabled ? 'â¸ï¸ Pause' : 'â–¶ï¸ Enable' %>
                </button>
                <button
                  class="btn-delete"
                  onclick="deleteReminder('<%= reminder.id %>')"
                >
                  ğŸ—‘ï¸ Delete
                </button>
              </div>
            </div>
            <% }); %>
          </div>
          <% } else { %>
          <div class="no-reminders">
            <p>ğŸ“­ No auto reminders configured yet.</p>
            <p>Create your first one above!</p>
          </div>
          <% } %>
        </section>
      </main>

      <footer>
        <p>WhatsApp Auto Reminder App &copy; <%= new Date().getFullYear() %></p>
        <p class="hint">
          ğŸ’¡ Tip: Make sure the bot is already a member of the target group
        </p>
        <p class="hint">
          ğŸ• Timezone: Asia/Jakarta (WIB) | Scheduler runs every minute
        </p>
      </footer>
    </div>

    <script>
      // Prevent double-click on buttons
      let isProcessing = false;

      async function toggleReminder(id, enabled) {
        if (isProcessing) return;
        isProcessing = true;

        try {
          const response = await fetch("/reminder/toggle", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ id, enabled: String(enabled) }),
          });

          if (response.ok) {
            location.reload();
          } else {
            alert("Failed to toggle reminder");
            isProcessing = false;
          }
        } catch (error) {
          alert("Error: " + error.message);
          isProcessing = false;
        }
      }

      async function deleteReminder(id) {
        if (isProcessing) return;
        if (!confirm("Are you sure you want to delete this reminder?")) {
          return;
        }

        isProcessing = true;

        try {
          const response = await fetch("/reminder/delete", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ id }),
          });

          if (response.ok) {
            location.reload();
          } else {
            const data = await response.json();
            alert("Failed to delete reminder: " + (data.error || "Unknown error"));
            isProcessing = false;
          }
        } catch (error) {
          alert("Error: " + error.message);
          isProcessing = false;
        }
      }

      // Prevent form double-submit
      document.querySelector('.reminder-form').addEventListener('submit', function(e) {
        if (isProcessing) {
          e.preventDefault();
          return;
        }
        isProcessing = true;
        this.querySelector('button[type="submit"]').disabled = true;
        this.querySelector('button[type="submit"]').textContent = 'â³ Saving...';
      });
    </script>
  </body>
</html>
